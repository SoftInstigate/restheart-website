---
title: Managing Binary Files with RESTHeart
layout: docs-adoc
menu: mongodb
---

RESTHeart provides full support for storing and retrieving binary files of any size in MongoDB. This functionality uses MongoDB's **GridFS**, which allows storing files that exceed the BSON document size limit of 16MB.

TIP: GridFS automatically splits large files into smaller chunks and stores them in separate documents.

=== File Buckets

==== What is a File Bucket?

A file bucket is a special collection designed for storing binary files along with their metadata. In MongoDB terms, it's a GridFS bucket.

IMPORTANT: File bucket names must end with `.files` (e.g., `images.files` is a valid file bucket name)

==== Creating a File Bucket

To store binary files, first create a file bucket:

[source,http]
----
PUT /mybucket.files HTTP/1.1

HTTP/1.1 201 Created
----

=== Uploading Files

==== POST - Upload a New File

To upload a file, use a `POST` request with `multipart/form-data` encoding:

[source,http]
----
POST /mybucket.files HTTP/1.1
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="example.jpg"
Content-Type: image/jpeg

(binary data)
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="metadata"

{"author":"SoftInstigate", "category":"documentation"}
------WebKitFormBoundary7MA4YWxkTrZu0gW--
----

The request has two parts:
* `file`: The binary content of the file
* `metadata`: A JSON object with custom metadata (optional)

Using command-line tools:

With cURL::

[source,bash]
----
$ curl -X POST \
  -u admin:secret \
  -F "file=@/path/to/example.jpg" \
  -F 'metadata={"author":"SoftInstigate","category":"documentation"}' \
  http://localhost:8080/mybucket.files
----

With HTTPie::

[source,bash]
----
$ http -a admin:secret --form POST \
  localhost:8080/mybucket.files \
  file@/path/to/example.jpg \
  metadata='{"author":"SoftInstigate","category":"documentation"}'
----

A successful upload returns:

[source,http]
----
HTTP/1.1 201 Created
Location: http://localhost:8080/mybucket.files/60f8a7b9e4b053f542c13ece
----

The `Location` header contains the URI of the newly created file, with the automatically generated ID.

==== PUT - Upload with a Custom ID

To upload a file with a specific ID, use a `PUT` request:

[source,bash]
----
$ curl -X PUT \
  -u admin:secret \
  -F "file=@/path/to/example.jpg" \
  -F 'metadata={"author":"SoftInstigate","category":"documentation"}' \
  http://localhost:8080/mybucket.files/my-custom-id
----

=== Retrieving Files

==== GET - File Metadata

To retrieve a file's metadata:

[source,http]
----
GET /mybucket.files/my-custom-id HTTP/1.1

HTTP/1.1 200 OK
Content-Type: application/json

{
    "_id": "my-custom-id",
    "chunkSize": 261120,
    "filename": "example.jpg",
    "length": 66273,
    "metadata": {
        "_etag": {
            "$oid": "60f8a7b9e4b053f542c13ecd"
        },
        "author": "SoftInstigate",
        "category": "documentation",
        "contentType": "image/jpeg"
    },
    "uploadDate": {
        "$date": 1626955705283
    }
}
----

The response includes:

* `_id`: The file identifier
* `chunkSize`: The size of each chunk in bytes
* `filename`: The original filename
* `length`: Total file size in bytes
* `metadata`: Custom metadata plus system-generated fields
* `uploadDate`: When the file was uploaded

==== GET - File Binary Content

To retrieve the actual binary file:

[source,http]
----
GET /mybucket.files/my-custom-id/binary HTTP/1.1

HTTP/1.1 200 OK
Content-Type: image/jpeg
Content-Length: 66273

(binary data)
----

RESTHeart automatically sets the appropriate `Content-Type` header based on the detected file type.

==== Filtering Files by Metadata

You can query files by their metadata just like regular documents:

[source,http]
----
GET /mybucket.files?filter={"metadata.author":"SoftInstigate"} HTTP/1.1
----

This returns metadata for all files with the specified author.

=== Updating File Metadata

==== PATCH - Update Specific Metadata Fields

To update specific metadata fields:

[source,http]
----
PATCH /mybucket.files/my-custom-id HTTP/1.1
Content-Type: application/json

{
    "metadata.category": "images",
    "metadata.tags": ["example", "documentation"]
}
----

IMPORTANT: When updating metadata, use `Content-Type: application/json`, not multipart/form-data.

==== PUT - Replace All Metadata

To completely replace the metadata:

[source,http]
----
PUT /mybucket.files/my-custom-id HTTP/1.1
Content-Type: application/json

{
    "metadata": {
        "author": "New Author",
        "category": "updated"
    }
}
----

NOTE: Update operators and aggregation pipelines cannot be used with file metadata updates.

=== Deleting Files

To delete a file and all its chunks:

[source,http]
----
DELETE /mybucket.files/my-custom-id HTTP/1.1
----

=== Important Notes

1. RESTHeart automatically detects and sets the file's content type
2. File operations don't support write modes - POST is always insert, PUT is always upsert
3. File metadata can be queried with the same operators as regular documents
4. File buckets have two underlying collections in MongoDB: `<bucket-name>.files` for metadata and `<bucket-name>.chunks` for content
5. Binary content is accessed with the `/binary` suffix

=== Examples

==== Example 1: Upload and serve an image

[source,bash]
----
# Upload an image
curl -X POST \
  -u admin:secret \
  -F "file=@/path/to/logo.png" \
  -F 'metadata={"purpose":"website"}' \
  http://localhost:8080/images.files

# Access the image in a web page
<img src="http://localhost:8080/images.files/60f8a7b9e4b053f542c13ece/binary" alt="Logo">
----

==== Example 2: Upload a document and track versions

[source,bash]
----
# Upload initial version
curl -X PUT \
  -u admin:secret \
  -F "file=@/path/to/document.pdf" \
  -F 'metadata={"version":"1.0","author":"John"}' \
  http://localhost:8080/documents.files/contract-2023

# Update the file and increment version
curl -X PUT \
  -u admin:secret \
  -F "file=@/path/to/document_updated.pdf" \
  -F 'metadata={"version":"1.1","author":"John","updated":"2023-07-15"}' \
  http://localhost:8080/documents.files/contract-2023
----
