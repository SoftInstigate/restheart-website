<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->

<html lang="en">
<!--<![endif]-->
<head>
   <meta charset="utf-8">
   <title>RESTHeart - Aggregations</title>
   <meta name="description" content="Low code API Framework for MongoDB">
   <meta name="author" content="SoftInstigate srl">
   <meta name="keywords" content="restheart,mongodb,rest,,graphql,api,http,microservice,java,framework">
   <!-- Open Graph -->
   <meta property="og:type" content="website">
   <meta property="og:url" content="https://restheart.org">
   <meta property="og:logo" content="/images/restheart logo.svg">
   <meta property="og:title" content="RESTHeart - Aggregations">
   <meta property="og:description" content="Low code API Framework for MongoDB">
   <meta property="og:locale" content="en">
   
   <!-- avoid search engine indexing of old documentation pages  -->
   <meta name="robots" content="noindex,nofollow">
   
   <!-- Mobile Specific Metas -->
   <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
   <!-- icon fonts -->
   <script src="/js/fontawesome.com_c39cf060d4.js"></script>
   <link type="text/css" rel="stylesheet" href="/font-icons/custom-icons/css/custom-icons.css">
   <link type="text/css" rel="stylesheet" href="/font-icons/custom-icons/css/custom-icons-ie7.css">
   <!-- Custom css -->
   <link rel="stylesheet" type="text/css" href="/css/main.css">
   <!-- js ================================================== -->
   <script src="https://code.jquery.com/jquery.min.js"></script>
   <script src="/assets/js/bootstrap.bundle.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js"></script>
   <script src="https://unpkg.com/@stackblitz/sdk/bundles/sdk.umd.js"></script>
   <script src="/js/carousel.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.6.0/slick.min.js"></script>
   <!-- Github buttons. -->
   <script async defer src="https://buttons.github.io/buttons.js"></script>
   <!--iframeResizer-->
  <script src="/assets/js/iframe-resizer.parent.js"></script>
   <!-- Favicons ================================================== -->
  <link rel="icon" type="image/svg+xml" href="/images/restheart logo.svg" />
  <link rel="shortcut icon" href="/images/favicon/favicon.png" />
  <link rel="canonical" href="https://restheart.org/docs/v5/aggregations">
  <link rel="alternate" type="application/atom+xml" title="RESTHeart - API Framework" href="https://restheart.org/feed.xml" />
  <script defer data-domain="restheart.org" src="https://plausible.io/js/script.js"></script>
</head>


<body>
    <header id="mainHeader" class="fixed-top background-primary" role="banner">
    <div class="container-fluid">
        <nav class="navbar navbar-default scrollMenu navbar-expand-lg" role="navigation">
            <a class="navbar-brand" href="/">
                <h2 class="text-white"><strong>REST</strong>Heart</h2>
            </a>
            <!-- Place this tag where you want the button to render. -->
            <button type="button" class="navbar-toggler" data-toggle="collapse" data-target=".navbar-ex1-collapse"><span
                    class="sr-only">Toggle navigation</span> &#x2630;</button>
            <div class="collapse navbar-collapse navbar-ex1-collapse background-primary" id="scrollTarget">
                <ul class="nav navbar-nav ml-md-auto">
                    <!-- only bounce slack button on home page-->
                    
                    

                    <li class="nav-item ml-1 ml-lg-2 ml-xl-4 mb-0 pb-0 ">
                        <a class="github-button" href="https://github.com/SoftInstigate/restheart" data-size="large" data-show-count="true" aria-label="Star SoftInstigate/restheart on GitHub"></a>
                    </li>
                    <li class="nav-item"><a class="ml-1 ml-lg-2 ml-xl-4" href="/docs/sophia">Ask Sophia</a></li>
                    <li class="nav-item"><a class="ml-1 ml-lg-2 ml-xl-4" href="/docs">Docs</a></li>
                    <li class="nav-item"><a class="ml-1 ml-lg-2 ml-xl-4" href="/docs/faq">FAQ</a></li>
                    <li class="nav-item"><a class="ml-1 ml-lg-2 ml-xl-4" href="/docs/setup-with-docker/">GET</a></li>
                    <li class="nav-item"><a class="ml-1 ml-lg-2 ml-xl-4" href="/contact">Contacts</a></li>
                </ul>
            </div>
        </nav>
    </div>
</header>

<div class="alert alert-warning m-0 text-center" role="alert">
    <strong>RESTHeart 8 is the current stable release. Switch documentation to <a href="/docs">v8</a></strong>
</div>



<a  target="_blank" class="gitter-open-chat-button fixed-bottom-right" href="https://join.slack.com/t/restheart/shared_invite/zt-1olrhtoq8-5DdYLBWYDonFGEALhmgSXQ"></a>


    <div class="page-content">
        <div class="container-fluid imgHover doc">
    <div class="row flex-xl-nowrap">
        <div class="col-12 col-md-3 col-xl-2 bd-sidebar">
            <div class="bd-sidebar__head">
                <div class="dropdown d-flex justify-content-center w-100">
                    <button class="btn btn-secondary dropdown-toggle w-100 p-1 mb-2" type="button"
                        id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        v5
                    </button>
                    <div class="dropdown-menu mt-2 mr-1 pb-2" aria-labelledby="dropdownMenuButton">
                      <a class="dropdown-item" href="/docs">
                            
                            v8
                            
                        </a>
                        <a class="dropdown-item" href="/docs/v7">
                            
                            v7
                            
                        </a>
                        <a class="dropdown-item" href="/docs/v6">
                            
                            v6
                            
                        </a>
                        <a class="dropdown-item" href="/docs/v5">
                            
                            <strong>v5</strong>
                            
                        </a>
                        <a class="dropdown-item" href="/docs/v4">
                            
                            v4
                            
                        </a>
                        <a class="dropdown-item" href="/docs/v3">
                            
                            v3
                            
                        </a>
                    </div>
                </div>
                <form action="https://www.google.com/search" class="form bd-sidebar__search d-flex" method="get"
                    name="searchform" target="_blank">
                    <input name="sitesearch" type="hidden" value="restheart.org/docs">
                    <input autocomplete="on" class="form-control input-sm search bd-sidebar__input" name="q"
                        placeholder="Search" required="required" type="text">
                    <button class="bd-sidebar__submit" type="submit">
                        <svg width="16" height="16">
                            <use xlink:href="/images/sprite.svg#search" /></svg>
                    </button>
                </form>
                <div class="d-flex flex-wrap justify-content-between align-items-center">
                    <a href="https://github.com/SoftInstigate/restheart-website/edit/master/docs/v5/aggregations.md"
                        class="small mt-2 mb-1 ml-lg-auto"><i class="icon-pencil"></i>Edit Page</a>
                    <button class="btn btn-link bd-sidebar__toggle navbar-expand-md p-0 mb-1 d-md-none" type="button"
                        data-toggle="collapse" data-target="#bd-sidebar__menu" aria-controls="bd-sidebar__menu"
                        aria-expanded="false" aria-label="Toggle docs navigation">
                        Table of Contents
                        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 30 30" width="30" height="30"
                            focusable="false">
                            <title>Menu</title>
                            <path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-miterlimit="10"
                                d="M4 7h22M4 15h22M4 23h22" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="bd-sidebar__menu collapse d-md-block" id="bd-sidebar__menu">
                
                    <h2 id="get-started"><a href="/docs/v5">Get Started</a></h2>
<ul>
    <li><a href="/docs/v5/setup">Setup</a></li>
    <li><a href="/docs/v5/try">Try RESTHeart online</a></li>
    <li><a href="/docs/v5/tutorial">Absolute Beginner Tutorial</a></li>
    <li><a href="/docs/v5/video-tutorials"><strong>Video Tutorials</strong></a></li>
    <li><a href="/docs/v5/quick-reference">Quick Reference</a></li>
    <li><a href="/docs/v5/resource-uri">Resource URIs</a></li>
    <li><a href="/docs/v5/graalvm">GraalVM</a></li>
    <li><a href="/docs/v5/representation-format">Representation Format</a></li>
    <li><a href="/docs/v5/logging">Logging</a></li>
    <li><a href="/docs/v5/blog-posts">Other tutorials</a></li>
    <li><a href="/docs/v5/performances">Performances</a></li>
    <li><a href="/docs/v5/clustering">Clustering & Load Balancing</a></li>
    <li><a href="/docs/v5/enterprise-license">Enterprise License</a></li>
</ul>

<h2 id="upgrade-to-v5"><a href="/docs/v5/upgrade-to-v5">Upgrade to v5</a></h2>
<h2 id="roadmap"><a href="/docs/v5/roadmap">Roadmap</a></h2>

<h2 id="content-api">Content API</h2>
<ul>
    <li><a href="/docs/v5/read-docs">Read JSON Documents</a></li>
    <li><a href="/docs/v5/write-docs">Write JSON Documents</a></li>
    <li><a href="/docs/v5/files">Binary Files with GridFS</a></li>
    <li><a href="/docs/v5/aggregations">Aggregations</a></li>
    <li><a href="/docs/v5/csv">Upload CSV files</a></li>
    <li><a href="/docs/v5/json-schema-validation">JSON Schema Validation</a></li>
    <li><a href="/docs/v5/change-streams">Change Streams</a></li>
    <li><a href="/docs/v5/transactions">Transactions</a></li>
</ul>

<h2 id="mgmt-api">Management API</h2>
<ul>
    <li><a href="/docs/v5/mgmt/dbs-collections">Databases and Collections</a></li>
    <li><a href="/docs/v5/mgmt/indexes">Indexes</a></li>
    <li><a href="/docs/v5/mgmt/relationships">Relationships</a></li>
</ul>

<h2 id="security">Securing Requests</h2>
<ul>
    <li><a href="/docs/v5/security/overview">Overview</a></li>
    <li><a href="/docs/v5/security/authentication">Authentication</a></li>
    <li><a href="/docs/v5/security/authorization">Authorization</a></li>
    <li><a href="/docs/v5/security/user-management">User Management</a></li>
    <li><a href="/docs/v5/security/tls">Configure TLS</a></li>
    <li><a href="/docs/v5/security/secure-connection-to-mongodb">Secure connection to MongoDB</a></li>
    <li><a href="/docs/v5/security/how-clients-authenticate">How Clients Authenticate</a></li>
</ul>

<h2 id="plugins">Plugins</h2>
<ul>
    <li><a href="/docs/v5/plugins/overview">Overview</a></li>
    <li><a href="/docs/v5/plugins/dev-env">Development Environment Setup</a></li>
    <li><a href="/docs/v5/plugins/core-plugins">Core Plugins</a></li>
    <li><a href="/docs/v5/plugins/security-plugins">Security Plugins</a></li>
    <li><a href="/docs/v5/plugins/deploy">How to deploy a Plugin</a></li>
</ul>

<h2 id="other-fatures">Other Features</h2>
<ul>
    <li><a href="/docs/v5/proxy">Proxying requests</a></li>
    <li><a href="/docs/v5/static-resources">Serving static resources</a></li>
    <li><a href="/docs/v5/etag">ETag</a></li>
    <li><a href="/docs/v5/cors-support">CORS Support</a></li>
    <li><a href="/docs/v5/shard-keys">Shard Keys</a></li>
    <li><a href="/docs/v5/speedup-requests-with-cursor-pools">Cursor Pools</a></li>
    <li><a href="/docs/v5/monitoring">Monitoring</a></li>
    <li><a href="/docs/v5/auditing">Auditing</a></li>
</ul>
                
            </div>
        </div>
        <div class="d-none d-xl-block col-xl-2 order-last bd-toc">

  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#theaggrscollection-metadata">The aggrs collection metadata</a>
      <ul>
        <li><a href="#aggregation-pipeline">aggregation pipeline</a></li>
        <li><a href="#map-reduce">Map-Reduce</a></li>
      </ul>
    </li>
    <li><a href="#examples">Examples</a></li>
    <li><a href="#materialized-views">Materialized Views</a></li>
    <li><a href="#passing-variables-to-aggregations">Passing variables to aggregations</a>
      <ul>
        <li><a href="#variables-in-stages-or-query">Variables in stages or query</a></li>
        <li><a href="#variables-in-map-reduce-functions">Variables in map reduce functions</a></li>
        <li><a href="#handling-paging-in-aggregations">Handling paging in aggregations</a></li>
      </ul>
    </li>
    <li><a href="#security-informations">Security information</a></li>
  </ul>

</div>
<div class="col-12 col-md-9 col-xl-8 py-md-3 bd-content">

  <div class="docs-head d-flex align-items-center justify-content-between">
    <h2 class="d-flex align-items-center m-0 pr-3">
        <span>Aggregations</span>
    </h2>
</div>

  <h2 id="introduction">Introduction</h2>

  <p class="bs-callout bs-callout-info">“Aggregations operations process data records and return computed results. Aggregation operations group values from multiple documents together, and can perform a variety of operations on the grouped data to return a single result.”</p>

  <p>RESTHeart manages aggregation operations: both <em>aggregation pipelines</em>
and <em>map reduce functions</em> are supported.</p>

  <p>In both cases only <em>inline</em> output type is supported, i.e. no result is directly
written to the DB server unless the <a href="#materialized-views">Materialized Views</a> is used.</p>

  <h2 id="theaggrscollection-metadata">The <em>aggrs</em> collection metadata</h2>

  <p>In RESTHeart, not only documents but also dbs and collections have
properties. Some properties are metadata, i.e. they have a special
meaning for RESTheart that influences its behavior.</p>

  <p>Use the collection metadata <code class="language-plaintext highlighter-rouge">aggrs</code> to define aggregations. <code class="language-plaintext highlighter-rouge">aggrs</code> is an array of <em>pipeline</em> or <em>mapReduce </em>objects:</p>

  <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/coll/_meta</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>


{
    "aggrs": [
        { &lt;aggregation_1&gt; },
        { &lt;aggregation_2&gt; },
        ...,
        { &lt;aggregation_n&gt; }
    ]
}
</code></pre></div>  </div>

  <h3 id="aggregation-pipeline">Aggregation pipeline</h3>

  <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"pipeline"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"uri"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;uri&gt;"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"stages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"&lt;stage_1&gt;"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"&lt;stage_2&gt;"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"..."</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"allowDiskUse"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>  </div>

  <div class="table-responsive">
<table class="ts">
<thead>
<tr class="header">
<th>Property</th>
<th>Description</th>
<th class="text-center">Mandatory</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>type</strong></td>
<td>for aggregation pipeline operations is &quot;pipeline&quot;</td>
<td sclass="text-center">yes</td>
</tr>
<tr class="even">
<td><strong>uri</strong></td>
<td>specifies the URI when the operation is bound under the path <code>/&lt;db&gt;/&lt;collection&gt;/_aggrs</code></td>
<td class="text-center">yes</td>
</tr>
<tr class="odd">
<td><strong>stages</strong></td>
<td><p>the MongoDB aggregation pipeline stages.</p>
<p>For more information refer to <a href="https://docs.mongodb.org/manual/core/aggregation-pipeline/" class="uri">https://docs.mongodb.org/manual/core/aggregation-pipeline/</a></p></td>
<td class="text-center">yes</td>
</tr>
</tbody>
</table>
</div>

  <p>To store stages with operators and using the dot notation, RESTHeart
<em>automatically</em> escapes the properties keys because of MongoDB’s <a href="https://docs.mongodb.org/manual/reference/limits/#Restrictions-on-Field-Names">Restrictions on Field
Names</a>:</p>

  <ul>
    <li>the $ prefix is “underscore escaped”, e.g. <code class="language-plaintext highlighter-rouge">$exists</code> is stored as
<code class="language-plaintext highlighter-rouge">_$exists</code></li>
    <li>dots are escaped as <strong>::</strong> e.g. <code class="language-plaintext highlighter-rouge">SD.prop</code> is stored as <code class="language-plaintext highlighter-rouge">SD::prop</code></li>
  </ul>

  <h3 id="map-reduce">Map-Reduce</h3>

  <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mapReduce"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"uri"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;uri&gt;"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"map"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;map_function&gt;"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"reduce"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;reduce_function&gt;"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;query&gt;"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>  </div>

  <div class="table-responsive">
<table class="ts">
<thead>
<tr class="header">
<th>Property</th>
<th>Description</th>
<th class="text-center">Mandatory</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>type</strong></td>
<td>for aggregation pipeline operations is &quot;mapReduce&quot;</td>
<td class="text-center">yes</td>
</tr>
<tr class="even">
<td><strong>uri</strong></td>
<td>specifies the URI when the operation is bound under /&lt;db&gt;/&lt;collection&gt;/_aggrs path.</td>
<td class="text-center">yes</td>
</tr>
<tr class="odd">
<td><strong>map</strong></td>
<td><p>the map function</p>
<p>For more information refer to <a href="https://docs.mongodb.org/manual/core/map-reduce/" class="uri">https://docs.mongodb.org/manual/core/map-reduce/</a></p></td>
<td class="text-center">yes</td>
</tr>
<tr class="even">
<td>reduce</td>
<td>the reduce function</td>
<td class="text-center">yes</td>
</tr>
<tr class="odd">
<td>query</td>
<td>the filter query</td>
<td class="text-center">no</td>
</tr>
</tbody>
</table>
</div>

  <h2 id="examples">Examples</h2>

  <p>The following requests upsert a collection defining two aggregation
operations:</p>

  <ul>
    <li>aggregation operation <em>test_ap</em> bound at
<code class="language-plaintext highlighter-rouge">/coll/_aggrs/example-pipeline</code></li>
    <li>map reduce operation <em>test_mr</em> bound at
<code class="language-plaintext highlighter-rouge">/coll/_aggrs/example-mapreduce</code></li>
  </ul>

  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUT /coll HTTP/1.1

{ "aggrs" : [ 
      { "stages" : [ { "$match" : { "name" : { "$var" : "n" } } },
            { "$group" : { "_id" : "$name",
                  "avg_age" : { "$avg" : "$age" }
                } }
          ],
        "type" : "pipeline",
        "uri" : "example-pipeline"
      },
      { "map" : "function() { emit(this.name, this.age) }",
        "query" : { "name" : { "$var" : "n" } },
        "reduce" : "function(key, values) { return Array.avg(values) }",
        "type" : "mapReduce",
        "uri" : "example-mapreduce"
      }
    ] }
</code></pre></div>  </div>

  <h2 id="materialized-views">Materialized Views</h2>

  <p>The <code class="language-plaintext highlighter-rouge">$merge</code> stage for the pipelines delivers the ability to create collections based on an aggregation and update those created collections efficiently, i.e. it just updates the generated results collection rather than rebuild it completely (like it would with the <code class="language-plaintext highlighter-rouge">$out</code> stage).</p>

  <p>It’s as simple as adding <code class="language-plaintext highlighter-rouge">$merge</code> as the last stage of the pipeline.</p>

  <p>The following example defines the aggregation <code class="language-plaintext highlighter-rouge">/coll/_aggrs/age-by-gender</code> that computes average ages grouping data by gender. <code class="language-plaintext highlighter-rouge">$merge</code> is used as the last stage of the pipeline to write computed data to the <code class="language-plaintext highlighter-rouge">avgAgeByGender</code> collection.</p>

  <p class="bs-callout bs-callout-warning">Materialized Views are available from MongoDB 4.2.</p>

  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUT /coll HTTP/1.1

{ "aggrs" : [
    { "stages" : [
        { "$group" : { "_id" : "$gender",  "avg_age" : { "$avg" : "$age" } } },
        { "$merge": { "into": "avgAgeByGender" } }
        ],
            "type" : "pipeline",
            "uri" : "age-by-gender"
        }
    ]
}
</code></pre></div>  </div>

  <p>Executing the aggregation request returns no data, but thanks to the <code class="language-plaintext highlighter-rouge">$merge</code> stage, the new collection <code class="language-plaintext highlighter-rouge">avgAgeByGender</code> gets created.</p>

  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /coll/_aggrs/avg-by-city HTTP/1.1

HTTP/1.1 200 OK
[]
</code></pre></div>  </div>

  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /avgAgeByGender HTTP/1.1

HTTP/1.1 200 OK
[
    { "_id": "male", "avg_age": 34.5 }
    { "_id": "female", "avg_age": 35.6 }
]
</code></pre></div>  </div>

  <h2 id="passing-variables-to-aggregations">Passing variables to aggregations</h2>

  <p>The query parameter <code class="language-plaintext highlighter-rouge">avars</code> allows passing variables to the aggregations.</p>

  <p class="bs-callout bs-callout-info">The value of a variable can be any valid JSON.
The following query parameter passes two variables, a number and an object: <code class="language-plaintext highlighter-rouge">?avars={ "number": 1, "object": {"a": {"json": "object" }} }</code></p>

  <p>For example, the previous example aggregations both use a variable named
“n”. *If the variable is not passed via the <code class="language-plaintext highlighter-rouge">avars</code> qparam, the request
fails.</p>

  <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /coll/_aggrs/example-pipeline HTTP/1.1

HTTP/1.1 400 Bad Request
...
<span class="o">{</span>
    <span class="s2">"http status code"</span>: 400,
    <span class="s2">"http status description"</span>: <span class="s2">"Bad Request"</span>,
    <span class="s2">"message"</span>: <span class="s2">"error executing aggreation pipeline: variable n not bound"</span>
<span class="o">}</span>
</code></pre></div>  </div>

  <p>Passing the variable n, the request succeeds:</p>

  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /coll/_aggrs/example-pipeline?avars={"n":1} HTTP/1.1

HTTP/1.1 200 OK
...
</code></pre></div>  </div>

  <h3 id="variables-in-stages-or-query">Variables in stages or query</h3>

  <p>Variables can be used in aggregation pipeline stages and map reduce
query as follows:</p>

  <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span> <span class="dl">"</span><span class="s2">$var</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">&lt;var_name&gt;</span><span class="dl">"</span> <span class="p">}</span>
</code></pre></div>  </div>

  <p>In case of map reduce operation previous example, the variable was used
to filter the documents to have the <em>name</em> property matching the
variable <em>n:</em></p>

  <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="dl">"</span><span class="s2">query</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">$var</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">n</span><span class="dl">"</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">...</span>
<span class="p">}</span>
</code></pre></div>  </div>

  <h3 id="variables-in-map-reduce-functions">Variables in map reduce functions</h3>

  <p>Variables are passed also to <em>map</em> and <em>reduce</em> javascript functions
where the variable <code class="language-plaintext highlighter-rouge">$vars</code> can be used. For instance:</p>

  <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">PATCH</span> <span class="nn">/coll</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>

{ "aggrs" : [
     {  "map" : "function() { var minage = JSON.parse($vars).minage; if (this.age &gt; minage ) { emit(this.name, this.age); }; }",
        "reduce" : "function(key, values) { return Array.avg(values) } }",
        "type" : "mapReduce",
        "uri" : "example-mapreduce"
      }
] }

HTTP/1.1 200 Ok
...
</code></pre></div>  </div>

  <p>Note the <em>map</em> function; <code class="language-plaintext highlighter-rouge">JSON.parse($vars)</code> allows to access the
variables passed with the query parameter <code class="language-plaintext highlighter-rouge">avars</code></p>

  <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
 <span class="kd">var</span> <span class="nx">minage</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">$vars</span><span class="p">).</span><span class="nx">minage</span><span class="p">;</span><span class="c1">// &lt;-- here we get minage from avars qparam</span>
 <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">age</span> <span class="o">&gt;</span> <span class="nx">minage</span> <span class="p">)</span> <span class="p">{</span> <span class="nx">emit</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">age</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>
</code></pre></div>  </div>

  <h2 id="handling-paging-in-aggregations">Handling paging in aggregations</h2>

  <p>Starting from RESTHeart v4.1.8 paging must be handled explicitly by the aggregation (until this version paging was handled automatically). This allows more flexibility and better performances.</p>

  <p>Starting from RESTHeart v4.2.0 the following aggregation variables can be used to allow handling paging in the aggregation via default <code class="language-plaintext highlighter-rouge">page</code> and <code class="language-plaintext highlighter-rouge">pagesize</code> query parameters:</p>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">@page</code> the value of the <code class="language-plaintext highlighter-rouge">page</code> query parameter</li>
    <li><code class="language-plaintext highlighter-rouge">@pagesize</code> the value of the <code class="language-plaintext highlighter-rouge">pagesize</code> query parameter</li>
    <li><code class="language-plaintext highlighter-rouge">@skip</code> to be used in <code class="language-plaintext highlighter-rouge">$skip</code> stage, equals to <code class="language-plaintext highlighter-rouge">(page-1)*pagesize</code></li>
    <li><code class="language-plaintext highlighter-rouge">@limit</code> to be used in <code class="language-plaintext highlighter-rouge">$limit</code> stage, equals to the value of the <code class="language-plaintext highlighter-rouge">pagesize</code> query parameter</li>
  </ul>

  <p>For example, the following defines the aggregation <code class="language-plaintext highlighter-rouge">/aggrs/paging</code> that uses the <code class="language-plaintext highlighter-rouge">@skip</code> and <code class="language-plaintext highlighter-rouge">@limit</code> variables. As a result, the request <code class="language-plaintext highlighter-rouge">GET /coll/_aggrs/paging?page=3&amp;pagesize=25</code> skips 50 documents, returning the following 25 documents.</p>

  <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"aggrs"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"uri"</span><span class="p">:</span><span class="w"> </span><span class="s2">"paging"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pipeline"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"stages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"$skip"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="nl">"$var"</span><span class="p">:</span><span class="w"> </span><span class="s2">"@skip"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"$limit"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="nl">"$var"</span><span class="p">:</span><span class="w"> </span><span class="s2">"@limit"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>  </div>

  <h3 id="security-informations">Security Informations</h3>

  <p>By default RESTHeart makes sure that the aggregation variables passed as query parameters don’t include MongoDB operators.</p>

  <p>This behavior is required to protect data from undesirable malicious query injection.</p>

  <p>Even though is highly discouraged, is possible to disable this check by editing the following property in the <code class="language-plaintext highlighter-rouge">restheart.yml</code> configuration file.</p>

  <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">### Security</span>

<span class="c1"># Check if aggregation variables use operators. allowing operators in aggregation variables</span>
<span class="c1"># is risky. requester can inject operators modifying the query</span>

<span class="na">aggregation-check-operators</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div>  </div>

</div>

    </div>
</div>
    </div>

    <footer class="bs-docs-footer mt-0">
  <!-- <script>!function (d, s, id) { var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https'; if (!d.getElementById(id)) { js = d.createElement(s); js.id = id; js.src = p + '://platform.twitter.com/widgets.js'; fjs.parentNode.insertBefore(js, fjs); } }(document, 'script', 'twitter-wjs');</script> -->
  <div id="fb-root"></div>
  <section id="mainFooter">
    <div class="container-fluid">
      <div>
        <div class="bs-docs-social">
          <ul class="socialNetwork">
            <li class="ml-auto">
              <a href="https://twitter.com/softinstigate" class="tips" title="Follow us on Twitter" data-original-title="follow us on Twitter"
                target="_blank">
                <svg class="socialNetwork__icon"><use xlink:href="/images/sprite.svg#twitter" /></svg>
              </a>
            </li>
            <li>
              <a href="https://github.com/softinstigate/restheart" class="tips" title="Get the source code" data-original-title="get the source code"
                target="_blank">
                <svg class="socialNetwork__icon"><use xlink:href="/images/sprite.svg#github" /></svg>
              </a>
            </li>
          </ul>
        </div>
      </div>
      <div>
        Made with
        <!--<span class="glyphicon glyphicon-heart"></span>-->
        <svg class="footer__like"><use xlink:href="/images/sprite.svg#like" /></svg>
        by
        <a href="https://www.softinstigate.com" target="_blank">SoftInstigate</a>
      </div>
      <div>
        <a href="https://softinstigate.com/en/privacy" class="mr-2 small">Privacy Policy</a>
        <a href="https://www.iubenda.com/privacy-policy/15571002/cookie-policy" class="small iubenda-nostyle no-brand iubenda-embed " title="Cookie Policy">Cookie Policy</a>
      </div>
    </section>
</footer>

    <!-- End Document ================================================== -->
</body>

</html>
<!-- add copy button on code snippet -->
<script src="/assets/js/clipboard.min.js"></script>
<style>
    .listingblock:hover .clipboard {
        display: block;
    }

    .clipboard {
        display: none;
        border: 0;
        font-size: .75em;
        text-transform: uppercase;
        font-weight: 800;
        padding: 2px;
        color: #999;
        position: absolute;
        top: 6px;
        right: 10px;
        background: transparent;
    }

    code + .clipboard {
        padding: 0;
    }

    .clipboard:hover, .clipboard:focus, .clipboard:active {
        outline: 0;
        color: white;
        /* background-color: #eee9e6; */
    }
</style>
<!-- add copy button on code snippet -->
<script>
    window.onload = function() {
        function target(b) {
            var p = b.parentNode;
            if (p.className.includes("highlight")) {
                var elems = p.getElementsByTagName("code");
                if (elems.length > 0) {
                    return elems[0];
                }
            }
            return p.childNodes[0];
        }

        var pre = document.getElementsByTagName('pre');
        for (var i = 0; i < pre.length; i++) {
            var b = document.createElement('button');
            b.className = 'clipboard';
            b.textContent = 'Copy';
            // b.innerHTML = '<i style="font-size:18px" class="icon-clipboard"></i>';
            if (pre[i].childNodes.length === 1 && pre[i].childNodes[0].nodeType === 3) {
                var div = document.createElement('div');
                div.textContent = pre[i].textContent;
                pre[i].textContent = '';
                pre[i].appendChild(div);
            }
            pre[i].appendChild(b);
        }

        var clipboard = new ClipboardJS('.clipboard', {
            // this custom text function, remove any line that doesn't start with $
            text: function (trigger) {
                var t = target(trigger);
                const text = target(trigger).outerText;

                if (text) {
                    const dataLang = t.getAttribute('data-lang');
                    if (dataLang === 'bash') {
                        return text
                            .replace(/^(?!\$.*$).*/gm, '') // remove lines that don't start with $
                            .replace(/^\$ */gm, '') // remove leading $
                            .replace(/^\s*[\r\n]/gm, '') // remove blank lines
                            .replace(/^\s+|\s+$/gm, ''); // trim string
                    }
                }
            },
            target: target
        });
        clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.textContent = 'Copied';
            setTimeout(function() {
                e.trigger.textContent = 'Copy';
            }, 2000);
        });
        clipboard.on('error', function(e) {
            console.error('Action:', e.action, e);
            console.error('Trigger:', e.trigger);
        });
    };
</script>