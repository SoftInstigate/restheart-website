<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->

<html lang="en">
<!--<![endif]-->
<head>
   <meta charset="utf-8">
   <title>RESTHeart - Upgrade to RESTHeart v8</title>
   <meta name="description" content="Low code API Framework for MongoDB">
   <meta name="author" content="SoftInstigate srl">
   <meta name="keywords" content="restheart,mongodb,rest,,graphql,api,http,microservice,java,framework">
   <!-- Open Graph -->
   <meta property="og:type" content="website">
   <meta property="og:url" content="https://restheart.org">
   <meta property="og:logo" content="/images/restheart logo.svg">
   <meta property="og:title" content="RESTHeart - Upgrade to RESTHeart v8">
   <meta property="og:description" content="Low code API Framework for MongoDB">
   <meta property="og:locale" content="en">
   
   <!-- Mobile Specific Metas -->
   <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
   <!-- icon fonts -->
   <script src="/js/fontawesome.com_c39cf060d4.js"></script>
   <link type="text/css" rel="stylesheet" href="/font-icons/custom-icons/css/custom-icons.css">
   <link type="text/css" rel="stylesheet" href="/font-icons/custom-icons/css/custom-icons-ie7.css">
   <!-- Custom css -->
   <link rel="stylesheet" type="text/css" href="/css/main.css">
   <!-- js ================================================== -->
   <script src="https://code.jquery.com/jquery.min.js"></script>
   <script src="/assets/js/bootstrap.bundle.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js"></script>
   <script src="https://unpkg.com/@stackblitz/sdk/bundles/sdk.umd.js"></script>
   <script src="/js/carousel.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.6.0/slick.min.js"></script>
   <!-- Github buttons. -->
   <script async defer src="https://buttons.github.io/buttons.js"></script>
   <!--iframeResizer-->
  <script src="/assets/js/iframe-resizer.parent.js"></script>
   <!-- Favicons ================================================== -->
  <link rel="icon" type="image/svg+xml" href="/images/restheart logo.svg" />
  <link rel="shortcut icon" href="/images/favicon/favicon.png" />
  <link rel="canonical" href="https://restheart.org/docs/upgrade-to-v8">
  <link rel="alternate" type="application/atom+xml" title="RESTHeart - API Framework" href="https://restheart.org/feed.xml" />
  <script defer data-domain="restheart.org" src="https://plausible.io/js/script.js"></script>
</head>


<body>
    <header id="mainHeader" class="fixed-top background-primary" role="banner">
    <div class="container-fluid">
        <nav class="navbar navbar-default scrollMenu navbar-expand-lg" role="navigation">
            <a class="navbar-brand" href="/">
                <h2 class="text-white"><strong>REST</strong>Heart</h2>
            </a>
            <!-- Place this tag where you want the button to render. -->
            <button type="button" class="navbar-toggler" data-toggle="collapse" data-target=".navbar-ex1-collapse"><span
                    class="sr-only">Toggle navigation</span> &#x2630;</button>
            <div class="collapse navbar-collapse navbar-ex1-collapse background-primary" id="scrollTarget">
                <ul class="nav navbar-nav ml-md-auto">
                    <!-- only bounce slack button on home page-->
                    
                    

                    <li class="nav-item ml-1 ml-lg-2 ml-xl-4 mb-0 pb-0 ">
                        <a class="github-button" href="https://github.com/SoftInstigate/restheart" data-size="large" data-show-count="true" aria-label="Star SoftInstigate/restheart on GitHub"></a>
                    </li>
                    <li class="nav-item"><a class="ml-1 ml-lg-2 ml-xl-4" href="/docs/sophia">Ask Sophia</a></li>
                    <li class="nav-item"><a class="ml-1 ml-lg-2 ml-xl-4" href="/docs">Docs</a></li>
                    <li class="nav-item"><a class="ml-1 ml-lg-2 ml-xl-4" href="/docs/faq">FAQ</a></li>
                    <li class="nav-item"><a class="ml-1 ml-lg-2 ml-xl-4" href="/docs/setup-with-docker/">GET</a></li>
                    <li class="nav-item"><a class="ml-1 ml-lg-2 ml-xl-4" href="/contact">Contacts</a></li>
                </ul>
            </div>
        </nav>
    </div>
</header>



<a  target="_blank" class="gitter-open-chat-button fixed-bottom-right" href="https://join.slack.com/t/restheart/shared_invite/zt-1olrhtoq8-5DdYLBWYDonFGEALhmgSXQ"></a>


    <div class="page-content">
        <div class="container-fluid imgHover doc">
    <div class="row flex-xl-nowrap">
        <div class="col-12 col-md-3 col-xl-2 bd-sidebar">
            <div class="bd-sidebar__head">
                <div class="dropdown d-flex justify-content-center w-100">
                    <button class="btn btn-secondary dropdown-toggle w-100 p-1 mb-2" type="button"
                        id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        v8
                    </button>
                    <div class="dropdown-menu mt-2 mr-1 pb-2" aria-labelledby="dropdownMenuButton">
                      <a class="dropdown-item" href="/docs">
                            
                            <strong>v8</strong>
                            
                        </a>
                        <a class="dropdown-item" href="/docs/v7">
                            
                            v7
                            
                        </a>
                        <a class="dropdown-item" href="/docs/v6">
                            
                            v6
                            
                        </a>
                        <a class="dropdown-item" href="/docs/v5">
                            
                            v5
                            
                        </a>
                        <a class="dropdown-item" href="/docs/v4">
                            
                            v4
                            
                        </a>
                        <a class="dropdown-item" href="/docs/v3">
                            
                            v3
                            
                        </a>
                    </div>
                </div>
                <form action="https://www.google.com/search" class="form bd-sidebar__search d-flex" method="get"
                    name="searchform" target="_blank">
                    <input name="sitesearch" type="hidden" value="restheart.org/docs">
                    <input autocomplete="on" class="form-control input-sm search bd-sidebar__input" name="q"
                        placeholder="Search" required="required" type="text">
                    <button class="bd-sidebar__submit" type="submit">
                        <svg width="16" height="16">
                            <use xlink:href="/images/sprite.svg#search" /></svg>
                    </button>
                </form>
                <div class="d-flex flex-wrap justify-content-between align-items-center">
                    <a href="https://github.com/SoftInstigate/restheart-website/edit/master/docs/upgrade-to-v8.adoc"
                        class="small mt-2 mb-1 ml-lg-auto"><i class="icon-pencil"></i>Edit Page</a>
                    <button class="btn btn-link bd-sidebar__toggle p-0 mb-1 d-md-none" type="button"
                        data-toggle="collapse" data-target="#bd-sidebar__menu" aria-controls="bd-sidebar__menu"
                        aria-expanded="false" aria-label="Toggle docs navigation">
                        Table of Contents
                        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 30 30" width="30" height="30"
                            focusable="false">
                            <title>Menu</title>
                            <path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-miterlimit="10" d="M4 7h22M4 15h22M4 23h22" />
                        </svg>
                    </button>
                </div>
            </div>

            <nav class="bd-sidebar__menu collapse d-md-block" id="bd-sidebar__menu">
                
                    
<a data-toggle="collapse" href="#overview" role="button" aria-expanded="false" aria-controls="collapseExample">
    <h2>Overview</h2>
</a>
<ul id="overview" class="collapse">
    <li><a href="/docs/upgrade-to-v8"><strong>Upgrade to v8</strong></a></li>
    <li><a href="/docs">Overview</a></li>
    <li><a href="/docs/faq">FAQ</a></li>
    <li><a href="/docs/mongodb-rest/demo-webapp">Demo WebApp with RESTHeart</a></li>
    <li><a href="/docs/performances">Performances</a></li>
    <li><a href="https://github.com/SoftInstigate/restheart/issues?q=is%3Aissue+is%3Aopen+label%3A%22feature+request%22">Roadmap</a></li>
    <li><a href="/docs/plugins/tutorial">Framework Tutorial</a></li>
    <li><a href="/docs/mongodb-rest/tutorial">REST API Tutorial</a></li>
    <li><a href="/docs/mongodb-graphql/tutorial">GraphQL API Tutorial</a></li>
    <li><a href="/docs/security/tutorial">Auth^2 Tutorial</a></li>
    <li><a href="/docs/example-webapps">Example Web Apps built with RESTHeart</a></li>
    <li><a href="/docs/blog-posts">Blog posts</a></li>
    <li><a href="/docs/video-tutorials">Video Tutorials</a></li>
</ul>

<a data-toggle="collapse" href="#setup" role="button" aria-expanded="false" aria-controls="collapseExample">
    <h2 class="mt-2">Setup</h2>
</a>
<ul id="setup" class="collapse">
    <li><a href="/docs/setup"><strong>Setup</strong></a></li>
    <li><a href="/docs/setup-with-docker">Setup with Docker</a></li>
    <li><a href="/docs/configuration">Configuration</a></li>
    <li><a href="/docs/default-configuration">Default Configuration</a></li>
    <li><a href="/docs/security/how-clients-authenticate">Client Authentication Howto</a></li>
    <li><a href="/docs/security/user-management">User Management</a></li>
    <li><a href="/docs/graalvm"><strong>GraalVM</strong></a></li>
    <li><a href="/docs/security/security-hardening"><strong>Security Hardening</strong></a></li>
    <li><a href="/docs/security/tls">Configure TLS</a></li>
    <li><a href="/docs/security/secure-connection-to-mongodb">Secure connection to MongoDB</a></li>
    <li><a href="/docs/proxy">Proxying requests</a></li>
    <li><a href="/docs/static-resources">Serving static resources</a></li>
    <li><a href="/docs/logging">Logging</a></li>
    <li><a href="/docs/monitoring">Monitoring</a></li>
    <li><a href="/docs/auditing">Auditing</a></li>
    <li><a href="/docs/clustering">Clustering &amp; Load Balancing</a></li>
    <li><a href="/docs/enterprise-license">Enterprise License</a></li>
</ul>

<a data-toggle="collapse" href="#framework" role="button" aria-expanded="false" aria-controls="collapseExample">
    <h2 class="mt-2">Framework</h2>
</a>
<ul id="framework" class="collapse">
    <!-- <li><a href="/docs/plugins/dev-env">Development Environment</a></li> -->
    <li><a href="/docs/plugins/overview">Overview</a></li>
    <li><a href="/docs/plugins/tutorial">Tutorial</a></li>
    <li><a href="/docs/plugins/deploy">How to deploy Plugins</a></li>
    <h3 id="rest-api" class="mt-2">Base Plugins</h2>
    <li><a href="/docs/plugins/services">Services</a></li>
    <li><a href="/docs/plugins/interceptors">Interceptors</a></li>
    <li><a href="/docs/plugins/providers">Providers</a></li>
    <li><a href="/docs/plugins/initializers">Initializers</a></li>
    <li><a href="/docs/plugins/core-plugins-js">Services and Inteceptors in JavaScript</a></li>
    <h3 id="rest-api" class="mt-2">Security Plugins</h2>
    <li><a href="/docs/security/overview">Overview</a></li>
    <li><a href="/docs/plugins/authentication-mechanisms">Authentication Mechanisms</a></li>
    <li><a href="/docs/plugins/authenticators">Authenticators</a></li>
    <li><a href="/docs/plugins/authorizers">Authorizers</a></li>
    <li><a href="/docs/plugins/token-managers">Token Managers</a></li>
</ul>

<a data-toggle="collapse" href="#security" role="button" aria-expanded="false" aria-controls="collapseExample">
    <h2 class="mt-2">Security Plugins</h2>
</a>
<ul id="security" class="collapse">
    <li><a href="/docs/security/tutorial">Auth^2 Tutorial</a></li>
    <li><a href="/docs/security/authentication">Authentication</a></li>
    <li><a href="/docs/security/authorization">Authorization</a></li>
    <li><a href="/docs/security/other-security-plugins">Other Security Plugins</a></li>
</ul>

<a  data-toggle="collapse" href="#mongodb" role="button" aria-expanded="false" aria-controls="collapseExample">
    <h2 class="mt-2">MongoDB Plugins</h2>
</a>
<ul id="mongodb" class="collapse">
    <h3 id="rest-api" class="mt-2">REST API</h2>
    <li><a href="/docs/mongodb-rest/tutorial">Getting Started</a></li>
    <li><a href="/docs/mongodb-rest/read-docs">Reading Documents</a></li>
    <li><a href="/docs/mongodb-rest/write-docs">Writing Documents</a></li>
    <li><a href="/docs/mongodb-rest/files">Managing Binary Files</a></li>
    <li><a href="/docs/mongodb-rest/aggregations">Aggregations</a></li>
    <li><a href="/docs/mongodb-rest/dbs-collections">Databases and Collections</a></li>
    <li><a href="/docs/mongodb-rest/indexes">Indexes</a></li>
    <li><a href="/docs/mongodb-rest/csv">CSV Import</a></li>
    <li><a href="/docs/mongodb-rest/transactions">Transactions</a></li>
    <li><a href="/docs/mongodb-rest/caching">Performance and Caching</a></li>
    <li><a href="/docs/mongodb-rest/relationships">Relationships</a></li>
    <li><a href="/docs/mongodb-rest/json-schema-validation">JSON Schema Validation</a></li>
    <li><a href="/docs/mongodb-rest/resource-uri">Resource URIs</a></li>
    <li><a href="/docs/mongodb-rest/representation-format">Representation Format</a></li>
    <li><a href="/docs/mongodb-rest/etag">ETag</a></li>
    <li><a href="/docs/mongodb-rest/shard-keys">Shard Keys</a></li>
    <li><a href="/docs/mongodb-rest/sample-data">Load Sample Data</a></li>

    <h3 id="rest-api" class="mt-2">GraphQL API</h3>
    <li><a href="/docs/mongodb-graphql/">Overview</a></li>
    <li><a href="/docs/mongodb-graphql/getting-started">Getting Started</a></li>
    <li><a href="/docs/mongodb-graphql/graphql-apps">App Definition</a>
        <ul>
            <li><a href="/docs/mongodb-graphql/schema">Schema Design</a></li>
            <li><a href="/docs/mongodb-graphql/mappings">MongoDB Mappings</a></li>
            <li><a href="/docs/mongodb-graphql/resolvers">Custom Resolvers</a></li>
        </ul>
    </li>
    <li><a href="/docs/mongodb-graphql/tutorial">Basic Tutorial</a></li>
    <li><a href="/docs/mongodb-graphql/complex-app-example">Advanced Example</a></li>
    <li><a href="/docs/mongodb-graphql/optimization">Performance Optimization</a></li>
    <li><a href="/docs/mongodb-graphql/best-practices">Best Practices</a></li>

    <h3 id="rest-api" class="mt-2">Websocket API</h3>
    <li><a href="/docs/mongodb-websocket/">Overview</a></li>
    <li><a href="/docs/mongodb-websocket/change-streams">Streams definition</a></li>
    <li><a href="/docs/mongodb-websocket/variables">Variables</a></li>
    <li><a href="/docs/mongodb-websocket/examples">Examples</a></li>
</ul>

<style>
.collapsing {
    -webkit-transition: none;
    transition: none;
    display: none;
}
</style>

<script type="text/javascript">
    // on page load, show the menu element of the current pages
    const menu = 'overview';
    if (menu) {
        $(`#${menu}`).collapse('show');
    }
</script>

                
            </nav>
        </div>

        <div class="d-none d-xl-block col-xl-2 order-last bd-toc">
            <ul class="sectlevel2">
<li><a href="#virtual-threads">Virtual Threads</a></li>
<li><a href="#cookie-authentication">Cookie Authentication</a></li>
<li><a href="#programmatic-configuration-of-acls">Programmatic Configuration of ACLs</a></li>
<li><a href="#lazy-load-request-content">Lazy-load Request Content</a></li>
</ul>
        </div>
        <div class="col-12 col-md-9 col-xl-8 py-md-3 bd-content">
            <div class="docs-head d-flex align-items-center justify-content-between">
    <h2 class="d-flex align-items-center m-0 pr-3">
        <span>Upgrade to RESTHeart v8</span>
    </h2>
</div>
            <div class="paragraph">
<p>RESTHeart v8 introduces many new features, improvements, and changes.</p>
</div>
<div class="paragraph">
<p>This page summarizes the new features and provides guidance on upgrading from previous versions.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Read <a href="https://medium.com/@andreadicesare/whats-new-in-restheart-v8-c87d8a77a1c6">What’s new in RESTHeart v8</a> on Medium
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="virtual-threads">Virtual Threads</h3>
<div class="paragraph">
<p>Java 21 introduces <strong>Virtual Threads</strong>, a feature detailed in <a href="http://openjdk.org/jeps/444">JEP 444</a>. These lightweight threads significantly boost performance and simplify concurrent programming.</p>
</div>
<div class="paragraph">
<p>RESTHeart 8 harnesses <code>Executors.newVirtualThreadPerTaskExecutor()</code> to manage requests handled by services marked as blocking (with <code>RegisterPlugin(blocking = true)</code> by default), efficiently processing blocking services.</p>
</div>
<div class="paragraph">
<p>Furthermore, RESTHeart 8 configures Undertow to use its <code>ThreadAwareByteBufferPool</code> for optimized resource allocation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Platform Threads:</strong> Uses the <code>undertow.DefaultByteBufferPool</code> to efficiently pool resources.</p>
</li>
<li>
<p><strong>Virtual Threads:</strong> Utilizes <code>NotPoolingByteBufferPool</code>, which avoids pooling to enhance performance given the distinct characteristics of virtual threads.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="rationale">Rationale</h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Virtual threads are lightweight, high-throughput threads that simplify the development, maintenance, and monitoring of concurrent applications.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect3">
<h4 id="configuration">Configuration</h4>
<div class="paragraph">
<p>The following options manage virtual threads:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">core</span><span class="pi">:</span>
  <span class="c1"># Specifies the initial number of platform carrier threads used for virtual threads in blocking operations.</span>
  <span class="c1"># Recommended value: 1.5 * number of cores.</span>
  <span class="c1"># If &lt;= 0, it defaults to 1.5 times the system core count.</span>
  <span class="na">workers-scheduler-parallelism</span><span class="pi">:</span> <span class="m">0</span>

  <span class="c1"># Sets the maximum number of platform carrier threads for virtual threads in blocking operations.</span>
  <span class="na">workers-scheduler-max-pool-size</span><span class="pi">:</span> <span class="s">256</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cookie-authentication">Cookie Authentication</h3>
<div class="paragraph">
<p>Allows storing the auth token in a secure cookie and enables authentication from it.</p>
</div>
<div class="paragraph">
<p><strong>Rationale</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using cookie authentication and JWT tokens effectively enables Single Sign-On.</p>
</li>
<li>
<p>Typically, a client first authenticates using Basic Authentication and then uses the auth token returned in the first response for further requests. This auth token is usually stored in the local storage by web clients. The local storage is readable by JavaScript, thus exposing this approach to Cross-site Scripting (XSS) security attacks. Storing the auth token in a secure cookie avoids XSS.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="overview">Overview</h4>
<div class="paragraph">
<p>Cookie Authentication allows the client browser to store an authentication token in a secure cookie. This mechanism enables authentication based on the stored cookie, allowing the client to remain authenticated across multiple requests without having to send credentials each time. The token is securely saved in the cookie, ensuring that sensitive data is protected and accessible only to the intended server.</p>
</div>
<div class="sect4">
<h5 id="configuration-options">Configuration Options</h5>
<div class="paragraph">
<p>Cookie Authentication is disabled by default. To enable it, the following three plugins must be enabled and configured: <code>authCookieSetter</code>, <code>authCookieHandler</code>, and <code>authCookieRemover</code>.</p>
</div>
<div class="paragraph">
<p>The cookie authentication mechanism can function using three different options:</p>
</div>
<div class="paragraph">
<p><strong>Option 1: JWT Verified by <code>jwtAuthenticationMechanism</code></strong>
This option is recommended if you also want to allow clients to authenticate via JWTs sent in the <code>Authorization</code> header (not stored in a cookie).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>/tokenBasicAuthMechanism/enabled-&gt;true|false
/jwtAuthenticationMechanism/enabled-&gt;true
/jwtTokenManager/enabled-&gt;true
/rndTokenManager/enabled-&gt;false</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Option 2: JWT Verified by <code>tokenBasicAuthMechanism</code></strong>
Choose this option if you have multiple instances of RESTHeart verifying cookies, and JWT header-based authentication isn&#8217;t required.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>/tokenBasicAuthMechanism/enabled-&gt;true
/jwtAuthenticationMechanism/enabled-&gt;false
/jwtTokenManager/enabled-&gt;true
/rndTokenManager/enabled-&gt;false</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Option 3: RGT Cookies (Randomly Generated Tokens)</strong>
For authentication via RGT cookies, enable these components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><code>tokenBasicAuthMechanism</code></strong>: Manages the basic authentication process.</p>
</li>
<li>
<p><strong><code>rndTokenManager</code></strong>: Manages and validates randomly generated tokens for Basic Authentication cookies.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>/tokenBasicAuthMechanism/enabled-&gt;true
/jwtAuthenticationMechanism/enabled-&gt;false
/jwtTokenManager/enabled-&gt;false
/rndTokenManager/enabled-&gt;true</code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Note:</strong> RGT cookies can only be verified by the RESTHeart instance that issued them. For multi-instance deployments, it is advisable to use JWT cookies instead.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect4">
<h5 id="authcookiesetter">authCookieSetter</h5>
<div class="paragraph">
<p>This component is responsible for initiating a user&#8217;s authenticated session by setting the authentication cookie.</p>
</div>
<div class="paragraph">
<p>Activates when a URL includes the query parameter <code>?set-auth-cookie</code> and a user is authenticated, setting a cookie populated with a token generated by the enabled Token Manager.</p>
</div>
<div class="paragraph">
<p><strong>Configuration</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">authCookieSetter</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">false</span>          <span class="c1"># Not enabled by default</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">rh_auth</span>           <span class="c1"># The name of the cookie to be set</span>
  <span class="na">domain</span><span class="pi">:</span> <span class="s">localhost</span>       <span class="c1"># The domain within which the cookie is valid</span>
  <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>                 <span class="c1"># The cookie path, applicable to the entire domain</span>
  <span class="na">http-only</span><span class="pi">:</span> <span class="no">true</span>         <span class="c1"># If true, enhances security by making the cookie inaccessible to JavaScript</span>
  <span class="na">same-site</span><span class="pi">:</span> <span class="no">true</span>         <span class="c1"># Restricts the cookie to first-party contexts, preventing CSRF attacks</span>
  <span class="na">same-site-mode</span><span class="pi">:</span> <span class="s">strict</span>  <span class="c1"># Strictly prevents the cookie from being sent along with cross-site requests</span>
  <span class="na">expires-ttl</span><span class="pi">:</span> <span class="m">86400</span>     <span class="c1"># Defines the duration (in seconds, default 1 day) for which the cookie is valid</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When using JWT tokens, the cookie can be updated by specifying both <code>?set-auth-cookie&amp;renew-auth-token</code>. The query parameter <code>renew-auth-token</code> forces the <code>jwtTokenManager</code> to update the JWT.</p>
</div>
</div>
<div class="sect4">
<h5 id="authcookiehandler">authCookieHandler</h5>
<div class="paragraph">
<p>Responsible for utilizing the authentication cookie to maintain authenticated sessions across requests.</p>
</div>
<div class="paragraph">
<p>Reads the <code>rh_auth</code> cookie (actual cookie name is defined in authCookieSetter configuration), if available, and constructs an Authorization header. This allows for seamless continuation of sessions and supports both Basic and JWT authentication mechanisms.</p>
</div>
<div class="paragraph">
<p><strong>Configuration</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">authCookieHandler</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">false</span>          <span class="c1"># Not enabled by default</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="authcookieremover">authCookieRemover</h5>
<div class="paragraph">
<p>Handles the secure and explicit termination of authenticated sessions.</p>
</div>
<div class="paragraph">
<p>Clears the authentication cookie in response to a <code>POST /logout</code> request. This effectively logs out the user by wiping the authentication cookie from the user&#8217;s browser, ensuring the session is securely terminated.</p>
</div>
<div class="paragraph">
<p><strong>Configuration</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">authCookieRemover</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">false</span>          <span class="c1"># Not enabled by default</span>
  <span class="na">secure</span><span class="pi">:</span> <span class="no">false</span>           <span class="c1"># If the request to clean the cookie should be authenticated</span>
  <span class="na">defaultUri</span><span class="pi">:</span> <span class="s">/logout</span>     <span class="c1"># The endpoint that triggers this service</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="example-usage">Example usage</h4>
<div class="paragraph">
<p>This is an example of how a user might log in, make some requests, and then log out within a system using cookie authentication with the configuration described previously. This example assumes that the system is web-based and communicates over HTTP.</p>
</div>
<div class="sect4">
<h5 id="logging-in">Logging In</h5>
<div class="paragraph">
<p>The user submits their credentials (username and password) via Basic Authentication (<code>Authorization</code> header) from a form on a client application, which sends a GET request to the`/roles/{username}` endpoint, including the <code>?set-auth-cookie</code> query parameters</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="http"><span class="nf">GET</span> <span class="nn">/roles/{username}?set-auth-cookie</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">localhost</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>
<span class="na">Authorization</span><span class="p">:</span> <span class="s">Basic YWRtaW46c2VjcmV0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the credentials are valid, the server responds by setting an <code>rh_auth</code> cookie containing the authentication token and returns a success response.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="http"><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Set-Cookie</span><span class="p">:</span> <span class="s">rh_auth="Basic YWRtaW46MmliNWFsaDFxajZ4eHY5aWlyOTZsejh1bnJjMHQzNWFucnEyYzh1cG12cHNpOGc3dDQ="; Version=1; Path=/; Domain=localhost; Secure; HttpOnly; Expires=Sat, 20 Apr 2024 11:53:00 GMT; SameSite=Strict</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>

<span class="p">{</span><span class="w">
    </span><span class="nl">"authenticated"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"roles"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"user-role"</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the value of the cookie doesn&#8217;t include the actual user credentials but uses the auth token generated by the enabled Token Manager.</p>
</div>
</div>
<div class="sect4">
<h5 id="making-authenticated-requests">Making Authenticated Requests</h5>
<div class="paragraph">
<p>Once the cookie is set, the user can make subsequent requests to the server. The browser automatically includes the <code>rh_auth</code> cookie with each request to the domain.</p>
</div>
<div class="paragraph">
<p>For example, if the user wants to access a protected resource, they might send a GET request to the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="http"><span class="nf">GET</span> <span class="nn">/protected-resource</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">localhost</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">rh_auth="Basic YWRtaW46MmliNWFsaDFxajZ4eHY5aWlyOTZsejh1bnJjMHQzNWFucnEyYzh1cG12cHNpOGc3dDQ="</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The server checks the cookie, validates the session, and if valid, responds with the requested data.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="http"><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>

<span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Here is your protected resource data."</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="logging-out">Logging Out</h5>
<div class="paragraph">
<p>To log out, the user sends a POST request to the logout endpoint. This request doesn&#8217;t need to include user credentials but should be made from the same domain to ensure the browser includes the authentication cookie.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="http"><span class="nf">POST</span> <span class="nn">/logout</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">localhost</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">rh_auth=</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The server processes the logout request and clears the authentication cookie by setting its value to null.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="http"><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Set-Cookie</span><span class="p">:</span> <span class="s">rh_auth=; path=/; domain=localhost; secure; HttpOnly; SameSite=Strict</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After this, the user is logged out, and their session is terminated. The cookie is invalidated, and any subsequent requests to the server that require authentication will fail until the user logs in again.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="programmatic-configuration-of-acls">Programmatic Configuration of ACLs</h3>
<div class="paragraph">
<p>We want to extend defining security policy rules programmatically by allowing both inclusive and exclusive security policies through veto and permission predicates.</p>
</div>
<div class="paragraph">
<p>Currently, RESTHeart allows defining a set of predicates via <code>PluginRegistry.getGlobalSecurityPredicates()</code> that must all resolve to <code>true</code> to allow the request. Under the hood, the global security predicates are enforced by the vetoer authorizer <code>GlobalPredicatesVetoer</code>.</p>
</div>
<div class="paragraph">
<p>For clarity, recall that an Authorizer can be either a VETOER or an ALLOWER. A request is allowed when no VETOER denies it and any ALLOWER allows it.</p>
</div>
<div class="paragraph">
<p>We want to extend and refactor this feature as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Move the current logic from <code>PluginRegistry</code> to an <code>ACLRegistry</code> that can be injected with <code>@Inject("acl-registry")</code></p>
</li>
<li>
<p>Rename global security predicates to "veto predicates" and rename the vetoer as <code>ACLRegistryVetoer</code></p>
</li>
<li>
<p>Symmetrically add allow predicates and the corresponding allower authorizer <code>ACLRegistryAllower</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Rationale</strong></p>
</div>
<div class="paragraph">
<p>By extending the definition of security policy rules programmatically, it will be possible to ship a secure service with its own security policy, avoiding the need to configure the ACL.</p>
</div>
<div class="paragraph">
<p>As an example, the <code>RoleService</code> mapped to <code>/roles/{userid}</code> can be secured and allowed to be requested only if the path parameter <code>userid</code> matches the authenticated user id. Currently, this is not secured to avoid the need to configure the ACL and the authorization is checked in the service code.</p>
</div>
<div class="paragraph">
<p><strong>Detailed documentation</strong></p>
</div>
<div class="paragraph">
<p>The <code>ACLRegistry</code> can be injected with <code>@Inject("acl-registry")</code> and allows defining Access Control Lists (ACLs) programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ACLRegistry</span> <span class="o">{</span>
    <span class="cm">/**
     * Registers a veto predicate that determines if a request should be denied.
     * When the predicate evaluates to true, the request is immediately forbidden (vetoed).
     * Additionally, a request will also be denied if it is not explicitly authorized by any
     * allow predicates or any other active allowing authorizers.
     *
     * @param veto The veto predicate to register. This predicate should return true to veto (deny) the request,
     *             and false to let the decision be further evaluated by allow predicates or other authorizers.
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerVeto</span><span class="o">(</span><span class="nc">Predicate</span><span class="o">&lt;</span><span class="nc">Request</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">veto</span><span class="o">);</span>

    <span class="cm">/**
     * Registers an allow predicate that determines if a request should be authorized.
     * The request is authorized if this predicate evaluates to true, provided that no veto predicates
     * or other active vetoer authorizers subsequently deny the request. This method helps in setting up
     * conditions under which requests can proceed unless explicitly vetoed.
     *
     * @param allow The allow predicate to register. This predicate should return true to authorize the request,
     *              unless it is vetoed by any veto predicates or other vetoing conditions.
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerAllow</span><span class="o">(</span><span class="nc">Predicate</span><span class="o">&lt;</span><span class="nc">Request</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">allow</span><span class="o">);</span>

    <span class="cm">/**
     * Registers a predicate that determines whether requests handled by the ACLRegistryAllower
     * require authentication. This method is used to specify conditions under which authentication
     * is mandatory. Typically, authentication is required unless there are allow predicates
     * explicitly authorizing requests that are not authenticated.
     *
     * @param authenticationRequired The predicate to determine if authentication is necessary.
     *                               It should return true if the request must be authenticated,
     *                               otherwise false if unauthenticated requests might be allowed.
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerAuthenticationRequirement</span><span class="o">(</span><span class="nc">Predicate</span><span class="o">&lt;</span><span class="nc">Request</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">authenticationRequired</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This registry is utilized by the <code>ACLRegistryVetoer</code> and <code>ACLRegistryAllower</code> authorizers to manage request permissions. The <code>ACLRegistryVetoer</code> denies requests based on veto predicates, while the <code>ACLRegistryAllower</code> grants permission to proceed with requests based on allow predicates.</p>
</div>
<div class="paragraph">
<p>A request is permitted to proceed if it is not denied by any <code>ACLRegistryVetoer</code> and at least one <code>ACLRegistryAllower</code> approves it.</p>
</div>
<div class="paragraph">
<p><strong>Example usage:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Inject</span><span class="o">(</span><span class="s">"acl-registry"</span><span class="o">)</span>
<span class="nc">ACLRegistry</span> <span class="n">registry</span><span class="o">;</span>

<span class="nd">@OnInit</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">registry</span><span class="o">.</span><span class="na">registerVeto</span><span class="o">(</span><span class="n">r</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="o">.</span><span class="na">getPath</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"/deny"</span><span class="o">));</span>
  <span class="n">registry</span><span class="o">.</span><span class="na">registerAllow</span><span class="o">(</span><span class="n">r</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="o">.</span><span class="na">getPath</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"/allow"</span><span class="o">));</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="lazy-load-request-content">Lazy-load Request Content</h3>
<div class="paragraph">
<p>Up to RESTHeart v7, requests processed by the <code>MongoService</code> are designed to lazy-load their content. This means that the request body is only read when <code>MongoRequest.getContent()</code> is invoked for the first time.</p>
</div>
<div class="paragraph">
<p>This lazy-loading approach significantly improves performance across various scenarios. For instance, it speeds up the request validation process and ensures that interceptors that don&#8217;t need to access the content can execute faster.</p>
</div>
<div class="paragraph">
<p>RESTHeart 8 extends this behavior to all request types.</p>
</div>
<div class="paragraph">
<p><strong>Rationale</strong></p>
</div>
<div class="paragraph">
<p>Optimizing request handling can enhance performance in cases where the request content is unnecessary. A common example includes situations where a request is denied due to insufficient permissions.</p>
</div>
<div class="paragraph">
<p><strong>Detailed Documentation</strong></p>
</div>
<div class="paragraph">
<p>The <code>ServiceRequest</code> class now features a new abstract method to read and parse the request content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="cm">/**
 * Parses the content from the exchange and converts it into an instance of the specified type {@code T}.
 *
 * This method retrieves data from the exchange, interprets it according to the expected format, and converts
 * this data into an object of type {@code T}.
 *
 * @return an instance of {@code T} representing the parsed content
 * @throws IOException if an I/O error occurs
 * @throws BadRequestException if the content doesn't conform to the expected format of type {@code T}
 */</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="no">T</span> <span class="nf">parseContent</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">BadRequestException</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ServiceRequest.parseContent()</code> is called by <code>ServiceRequest.getContent()</code> on its first invocation. The parsed content is then cached and linked to the request, ensuring that any subsequent calls will reuse the already parsed content object.</p>
</div>
<div class="paragraph">
<p>This approach makes handling request content more efficient by reducing unnecessary parsing and processing overhead.</p>
</div>
</div>
        </div>
    </div>
</div>
    </div>

    <footer class="bs-docs-footer mt-0">
  <!-- <script>!function (d, s, id) { var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https'; if (!d.getElementById(id)) { js = d.createElement(s); js.id = id; js.src = p + '://platform.twitter.com/widgets.js'; fjs.parentNode.insertBefore(js, fjs); } }(document, 'script', 'twitter-wjs');</script> -->
  <div id="fb-root"></div>
  <section id="mainFooter">
    <div class="container-fluid">
      <div>
        <div class="bs-docs-social">
          <ul class="socialNetwork">
            <li class="ml-auto">
              <a href="https://twitter.com/softinstigate" class="tips" title="Follow us on Twitter" data-original-title="follow us on Twitter"
                target="_blank">
                <svg class="socialNetwork__icon"><use xlink:href="/images/sprite.svg#twitter" /></svg>
              </a>
            </li>
            <li>
              <a href="https://github.com/softinstigate/restheart" class="tips" title="Get the source code" data-original-title="get the source code"
                target="_blank">
                <svg class="socialNetwork__icon"><use xlink:href="/images/sprite.svg#github" /></svg>
              </a>
            </li>
          </ul>
        </div>
      </div>
      <div>
        Made with
        <!--<span class="glyphicon glyphicon-heart"></span>-->
        <svg class="footer__like"><use xlink:href="/images/sprite.svg#like" /></svg>
        by
        <a href="https://www.softinstigate.com" target="_blank">SoftInstigate</a>
      </div>
      <div>
        <a href="https://softinstigate.com/en/privacy" class="mr-2 small">Privacy Policy</a>
        <a href="https://www.iubenda.com/privacy-policy/15571002/cookie-policy" class="small iubenda-nostyle no-brand iubenda-embed " title="Cookie Policy">Cookie Policy</a>
      </div>
    </section>
</footer>

    <!-- End Document ================================================== -->
</body>

</html>
<!-- add copy button on code snippet -->
<script src="/assets/js/clipboard.min.js"></script>
<style>
    .listingblock:hover .clipboard {
        display: block;
    }

    .clipboard {
        display: none;
        border: 0;
        font-size: .75em;
        text-transform: uppercase;
        font-weight: 800;
        padding: 2px;
        color: #999;
        position: absolute;
        top: 6px;
        right: 10px;
        background: transparent;
    }

    code + .clipboard {
        padding: 0;
    }

    .clipboard:hover, .clipboard:focus, .clipboard:active {
        outline: 0;
        color: white;
        /* background-color: #eee9e6; */
    }
</style>
<!-- add copy button on code snippet -->
<script>
    window.onload = function() {
        function target(b) {
            var p = b.parentNode;
            if (p.className.includes("highlight")) {
                var elems = p.getElementsByTagName("code");
                if (elems.length > 0) {
                    return elems[0];
                }
            }
            return p.childNodes[0];
        }

        var pre = document.getElementsByTagName('pre');
        for (var i = 0; i < pre.length; i++) {
            var b = document.createElement('button');
            b.className = 'clipboard';
            b.textContent = 'Copy';
            // b.innerHTML = '<i style="font-size:18px" class="icon-clipboard"></i>';
            if (pre[i].childNodes.length === 1 && pre[i].childNodes[0].nodeType === 3) {
                var div = document.createElement('div');
                div.textContent = pre[i].textContent;
                pre[i].textContent = '';
                pre[i].appendChild(div);
            }
            pre[i].appendChild(b);
        }

        var clipboard = new ClipboardJS('.clipboard', {
            // this custom text function, remove any line that doesn't start with $
            text: function (trigger) {
                var t = target(trigger);
                const text = target(trigger).outerText;

                if (text) {
                    const dataLang = t.getAttribute('data-lang');
                    if (dataLang === 'bash') {
                        return text
                            .replace(/^(?!\$.*$).*/gm, '') // remove lines that don't start with $
                            .replace(/^\$ */gm, '') // remove leading $
                            .replace(/^\s*[\r\n]/gm, '') // remove blank lines
                            .replace(/^\s+|\s+$/gm, ''); // trim string
                    }
                }
            },
            target: target
        });
        clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.textContent = 'Copied';
            setTimeout(function() {
                e.trigger.textContent = 'Copy';
            }, 2000);
        });
        clipboard.on('error', function(e) {
            console.error('Action:', e.action, e);
            console.error('Trigger:', e.trigger);
        });
    };
</script>